<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Obra v2.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e14;
      --s1: #0f1419;
      --s2: #161c24;
      --s3: #1d2530;
      --border: #253040;
      --border2: #1d2530;
      --accent: #f7c948;
      --red: #e05c3a;
      --blue: #3aafe0;
      --green: #3fb950;
      --purple: #b97aff;
      --text: #cdd9e5;
      --text2: #768390;
      --text3: #444c56
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      height: 48px;
      background: var(--s1);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0
    }

    .logo {
      background: var(--accent);
      color: #000;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 600;
      font-size: 10px;
      padding: 3px 7px;
      letter-spacing: .08em
    }

    .header-info h1 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: -.01em
    }

    .header-info p {
      font-size: 10px;
      color: var(--text2);
      font-family: 'IBM Plex Mono', monospace
    }

    .header-tabs {
      margin-left: auto;
      display: flex;
      gap: 2px
    }

    .tab-btn {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      padding: 5px 14px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text2);
      cursor: pointer;
      transition: all .15s;
      letter-spacing: .05em
    }

    .tab-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: 600
    }

    .tab-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent)
    }

    .app {
      display: flex;
      height: calc(100vh - 48px)
    }

    .sidebar {
      width: 300px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--s1);
      overflow: hidden
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0
    }

    .sb-top {
      padding: 12px;
      border-bottom: 1px solid var(--border2);
      flex-shrink: 0
    }

    .sb-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-bottom: 8px
    }

    .rubro-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px
    }

    .chip {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      padding: 2px 7px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text2);
      cursor: pointer;
      transition: all .12s;
      letter-spacing: .04em
    }

    .chip:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: 600
    }

    .search {
      width: 100%;
      background: var(--s2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 10px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 12px;
      outline: none;
      transition: border-color .15s
    }

    .search:focus {
      border-color: var(--accent)
    }

    .search::placeholder {
      color: var(--text3)
    }

    .items-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 6px
    }

    .items-scroll::-webkit-scrollbar {
      width: 3px
    }

    .items-scroll::-webkit-scrollbar-thumb {
      background: var(--border)
    }

    .item-row {
      padding: 8px 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all .12s;
      margin-bottom: 2px
    }

    .item-row:hover {
      border-color: var(--border);
      background: var(--s2)
    }

    .item-row.sel {
      border-color: var(--accent);
      background: rgba(247, 201, 72, .05)
    }

    .item-row.cascade {
      border-color: var(--red);
      background: rgba(224, 92, 58, .04)
    }

    .item-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--accent);
      margin-bottom: 2px
    }

    .item-id.cascade-id {
      color: var(--red)
    }

    .item-name {
      font-size: 11px;
      color: var(--text);
      line-height: 1.35
    }

    .item-foot {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px
    }

    .item-inc {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text2)
    }

    .item-dur {
      font-size: 9px;
      color: var(--text3)
    }

    .cascade-tag {
      font-size: 8px;
      background: rgba(224, 92, 58, .15);
      color: var(--red);
      padding: 1px 5px;
      font-family: 'IBM Plex Mono', monospace;
      border: 1px solid rgba(224, 92, 58, .3)
    }

    .item-check {
      margin-left: auto;
      width: 12px;
      height: 12px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      flex-shrink: 0
    }

    .item-row.sel .item-check {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: 700
    }

    .item-row.cascade .item-check {
      background: var(--red);
      border-color: var(--red);
      color: #fff
    }

    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden
    }

    .tab-content.active {
      display: flex
    }

    #tab-sim {
      overflow-y: auto
    }

    .sim-top {
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      overflow-y: auto;
      max-height: 280px
    }

    .sel-panel {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border2);
      background: var(--s1)
    }

    .sel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px
    }

    .sel-header span {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: .08em;
      text-transform: uppercase
    }

    .btn-sm {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      padding: 3px 9px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text2);
      cursor: pointer;
      transition: all .12s
    }

    .btn-sm:hover {
      border-color: var(--red);
      color: var(--red)
    }

    .sel-rows {
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 130px;
      overflow-y: auto
    }

    .sel-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      background: var(--s2);
      border: 1px solid var(--border2)
    }

    .sel-row.is-cascade {
      border-left: 2px solid var(--red);
      opacity: .8
    }

    .sr-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--accent);
      min-width: 80px
    }

    .sr-name {
      font-size: 11px;
      color: var(--text);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .sr-delay {
      display: flex;
      align-items: center;
      gap: 6px
    }

    .sr-delay label {
      font-size: 10px;
      color: var(--text2);
      white-space: nowrap
    }

    .delay-inp {
      width: 52px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--red);
      padding: 3px 6px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      outline: none;
      transition: border-color .12s
    }

    .delay-inp:focus {
      border-color: var(--red)
    }

    .cascade-lbl {
      font-size: 9px;
      color: var(--red);
      font-family: 'IBM Plex Mono', monospace;
      white-space: nowrap
    }

    .edit-cascade-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text3);
      cursor: pointer;
      font-size: 10px;
      padding: 2px 6px;
      transition: all .12s;
      margin-left: 4px
    }

    .edit-cascade-btn:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .chart-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 20, .96);
      z-index: 1000;
      flex-direction: column;
      padding: 24px
    }

    .chart-overlay.open {
      display: flex
    }

    .chart-overlay-inner {
      flex: 1;
      position: relative;
      min-height: 0
    }

    .expand-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text3);
      cursor: pointer;
      font-size: 10px;
      padding: 3px 8px;
      margin-left: auto;
      transition: all .15s
    }

    .expand-btn:hover {
      border-color: var(--accent);
      color: var(--accent)
    }

    .rm-btn {
      background: transparent;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 12px;
      padding: 0 3px;
      transition: color .12s
    }

    .rm-btn:hover {
      color: var(--red)
    }

    .empty-sel {
      padding: 12px;
      text-align: center;
      color: var(--text3);
      font-size: 11px;
      font-family: 'IBM Plex Mono', monospace;
      border: 1px dashed var(--border2)
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1px;
      background: var(--border2);
      flex-shrink: 0
    }

    .metric {
      padding: 10px 14px;
      background: var(--s2)
    }

    .met-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 8px;
      color: var(--text3);
      letter-spacing: .07em;
      text-transform: uppercase;
      margin-bottom: 3px
    }

    .met-val {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 18px;
      font-weight: 600;
      line-height: 1
    }

    .met-val.ok {
      color: var(--green)
    }

    .met-val.warn {
      color: var(--accent)
    }

    .met-val.danger {
      color: var(--red)
    }

    .met-val.info {
      color: var(--blue)
    }

    .met-sub {
      font-size: 9px;
      color: var(--text3);
      margin-top: 2px
    }

    .chart-zone {
      flex-shrink: 0;
      height: 220px;
      padding: 10px 18px 6px;
      display: flex;
      flex-direction: column
    }

    .chart-hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-shrink: 0
    }

    .chart-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text)
    }

    .legend {
      display: flex;
      gap: 16px
    }

    .leg-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 9px;
      color: var(--text2);
      font-family: 'IBM Plex Mono', monospace
    }

    .leg-line {
      width: 18px;
      height: 2px;
      border-radius: 1px
    }

    .chart-wrap {
      flex: 1;
      position: relative;
      min-height: 0;
      max-height: 175px
    }

    .impact-zone {
      border-top: 1px solid var(--border);
      background: var(--s1);
      flex-shrink: 0;
      padding: 0 18px 8px
    }

    .recovery-zone {
      border-top: 1px solid var(--border);
      background: var(--s1);
      flex-shrink: 0;
      padding: 0 18px 12px
    }

    .impact-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: .07em;
      text-transform: uppercase;
      padding: 8px 0 5px;
      position: sticky;
      top: 0;
      background: var(--s1)
    }

    .impact-tbl {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px
    }

    .impact-tbl th {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 8px;
      color: var(--text3);
      letter-spacing: .06em;
      text-transform: uppercase;
      padding: 3px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border2)
    }

    .impact-tbl td {
      padding: 4px 8px;
      border-bottom: 1px solid rgba(37, 48, 64, .4);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px
    }

    .name-col {
      font-family: 'IBM Plex Sans', sans-serif !important;
      font-size: 10px !important;
      color: var(--text);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .spi-layout {
      flex: 1;
      display: flex;
      overflow: hidden
    }

    .spi-input-panel {
      width: 260px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--s1);
      overflow-y: auto;
      padding: 14px
    }

    .spi-input-panel::-webkit-scrollbar {
      width: 3px
    }

    .spi-input-panel::-webkit-scrollbar-thumb {
      background: var(--border)
    }

    .spi-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 14px 18px
    }

    .spi-section-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: .08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border2)
    }

    .spi-mes-row {
      display: grid;
      grid-template-columns: 55px 1fr 30px;
      gap: 6px;
      align-items: center;
      margin-bottom: 5px
    }

    .spi-mes-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--text2)
    }

    .spi-inp {
      background: var(--s2);
      border: 1px solid var(--border);
      color: var(--blue);
      padding: 4px 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      outline: none;
      transition: border-color .12s;
      width: 100%
    }

    .spi-inp:focus {
      border-color: var(--blue)
    }

    .spi-inp::placeholder {
      color: var(--text3);
      font-size: 9px
    }

    .spi-inp.has-val {
      border-color: rgba(58, 175, 224, .4);
      background: rgba(58, 175, 224, .04)
    }

    .spi-pct {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3)
    }

    .btn-primary {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      padding: 7px 16px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #000;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      margin-top: 10px;
      letter-spacing: .05em;
      transition: opacity .15s
    }

    .btn-primary:hover {
      opacity: .85
    }

    .spi-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 14px;
      flex-shrink: 0
    }

    .spi-met {
      padding: 10px 12px;
      background: var(--s2);
      border: 1px solid var(--border2)
    }

    .spi-charts {
      flex: 1;
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      min-height: 0
    }

    .chart-card {
      background: var(--s2);
      border: 1px solid var(--border2);
      padding: 10px;
      display: flex;
      flex-direction: column
    }

    .chart-card-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      flex-shrink: 0
    }

    .chart-card-wrap {
      flex: 1;
      position: relative;
      min-height: 0
    }

    .deps-layout {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 14px 18px
    }

    .deps-hdr {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
      flex-shrink: 0
    }

    .deps-hdr h2 {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap
    }

    .deps-hdr p {
      font-size: 11px;
      color: var(--text2)
    }

    .deps-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-shrink: 0;
      align-items: center;
      flex-wrap: wrap
    }

    .dep-tipo {
      font-size: 8px;
      padding: 1px 6px;
      border: 1px solid var(--border)
    }

    .dep-tipo.jerarquia {
      color: var(--purple);
      border-color: rgba(185, 122, 255, .3);
      background: rgba(185, 122, 255, .06)
    }

    .dep-tipo.rubro {
      color: var(--green);
      border-color: rgba(63, 185, 80, .3);
      background: rgba(63, 185, 80, .06)
    }

    .dep-tipo.manual {
      color: var(--accent);
      border-color: rgba(247, 201, 72, .3);
      background: rgba(247, 201, 72, .06)
    }

    .deps-table-wrap {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border2)
    }

    .deps-table-wrap::-webkit-scrollbar {
      width: 4px
    }

    .deps-table-wrap::-webkit-scrollbar-thumb {
      background: var(--border)
    }

    .deps-tbl {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px
    }

    .deps-tbl th {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 9px;
      color: var(--text3);
      letter-spacing: .06em;
      text-transform: uppercase;
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      background: var(--s2);
      position: sticky;
      top: 0;
      z-index: 1
    }

    .deps-tbl td {
      padding: 5px 10px;
      border-bottom: 1px solid rgba(37, 48, 64, .5);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px
    }

    .deps-tbl tr:hover td {
      background: var(--s2)
    }

    .dep-from {
      color: var(--accent)
    }

    .dep-to {
      color: var(--blue)
    }

    .dep-del-btn {
      background: transparent;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 11px;
      transition: color .12s
    }

    .dep-del-btn:hover {
      color: var(--red)
    }

    .add-dep-row {
      padding: 10px 14px;
      background: var(--s1);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0
    }

    .dep-select {
      background: var(--s2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 8px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      outline: none;
      flex: 1
    }

    .dep-select:focus {
      border-color: var(--accent)
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px
    }

    ::-webkit-scrollbar-track {
      background: transparent
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border)
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="logo">SIM v2.0</div>
    <div class="header-info">
      <h1>Simulador de Obra &mdash; Plan de Trabajo</h1>
      <p>Esc. N&ordm; 0-143 Cerro Siete Colores &middot; APOLO SUR SA &middot; Base: Agosto 2025 &middot; 226
        &iacute;tems &middot; 17 meses</p>
    </div>
    <div class="header-tabs">
      <span id="saveIndicator"
        style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--green);opacity:0.4;transition:opacity .4s;margin-right:8px;white-space:nowrap">&#x25CF;
        Guardado</span>
      <button class="tab-btn active" data-tab="sim" onclick="showTab('sim')">&#x29DF; Simulador</button>
      <button class="tab-btn" data-tab="spi" onclick="showTab('spi')">&#x25C8; Avance Real / SPI</button>
      <button class="tab-btn" data-tab="deps" onclick="showTab('deps')">&#x29E2; Dependencias</button>
      <button class="tab-btn" onclick="clearState()"
        style="border-color:var(--red);color:var(--red);margin-left:6px">&#x21BA; Reset</button>
    </div>
  </div>

  <div class="app">
    <div class="sidebar">
      <div class="sb-top">
        <div class="sb-label">Filtrar por rubro</div>
        <div class="rubro-chips" id="rubroChips"></div>
        <input class="search" type="text" id="searchInput" placeholder="Buscar &iacute;tem...">
      </div>
      <div class="items-scroll" id="itemsList"></div>
    </div>

    <div class="main">

      <div class="tab-content active" id="tab-sim">
        <div class="sim-top">
          <div class="sel-panel">
            <div class="sel-header">
              <span>&Iacute;tems con atraso simulado</span>
              <button class="btn-sm" onclick="clearAll()">&#x2715; Limpiar todo</button>
            </div>
            <div class="sel-rows" id="selRows">
              <div class="empty-sel">&larr; Seleccion&aacute; &iacute;tems para simular atrasos</div>
            </div>
          </div>
          <div class="metrics" id="metricsBar">
            <div class="metric">
              <div class="met-label">Plazo original</div>
              <div class="met-val ok">17m</div>
              <div class="met-sub">Sin atrasos</div>
            </div>
            <div class="metric">
              <div class="met-label">Plazo simulado</div>
              <div class="met-val ok">17m</div>
              <div class="met-sub">Sin cambios</div>
            </div>
            <div class="metric">
              <div class="met-label">Manuales</div>
              <div class="met-val warn">0</div>
              <div class="met-sub">Seleccionados</div>
            </div>
            <div class="metric">
              <div class="met-label">Cascada</div>
              <div class="met-val danger">0</div>
              <div class="met-sub">Propagados auto</div>
            </div>
            <div class="metric">
              <div class="met-label">Incidencia</div>
              <div class="met-val ok">0.0%</div>
              <div class="met-sub">Afectada</div>
            </div>
          </div>
        </div>
        <div class="chart-zone">
          <div class="chart-hdr">
            <span class="chart-title">Curva S &mdash; Avance F&iacute;sico Acumulado</span>
            <div class="legend">
              <div class="leg-item">
                <div class="leg-line" style="background:var(--blue)"></div>Plan original
              </div>
              <div class="leg-item">
                <div class="leg-line" style="background:var(--red)"></div>Con atrasos
              </div>
              <div class="leg-item">
                <div class="leg-line" style="background:var(--green)"></div>Recuperaci&oacute;n
              </div>
            </div>
            <button class="expand-btn" onclick="toggleChartOverlay()"
              title="Ver gr&aacute;fico en pantalla completa">&#x26F6; Expandir</button>
          </div>
          <div class="chart-wrap"><canvas id="curvaSChart"></canvas></div>
        </div>
        <div class="impact-zone">
          <div class="impact-title">Detalle de impacto por &iacute;tem</div>
          <div id="impactTable"></div>
        </div>
        <div class="recovery-zone">
          <div class="impact-title" style="display:flex;align-items:center;gap:8px">
            <span style="color:var(--green)">&#x25B
